<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Template Ersteller ‚Äì PW Toolbox</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* ===========================
           RESET & BASE
           =========================== */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Roboto', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f5f3f0;
            color: #44403c;
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
        }

        /* ===========================
           HEADER
           =========================== */
        .main-header {
            background: white;
            padding: 16px 30px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 16px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.06);
        }
        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            text-decoration: none;
            color: #f2a93b;
            font-weight: 500;
            font-size: 14px;
            padding: 6px 14px;
            border-radius: 6px;
            border: 2px solid #f2a93b;
            transition: all 0.2s;
        }
        .back-link:hover { background: #f2a93b; color: #fff; }
        .main-header h1 { font-size: 22px; color: #44403c; font-weight: 600; }

        /* ===========================
           LAYOUT: 3 Spalten
           =========================== */
        .app-layout {
            display: grid;
            grid-template-columns: 220px 1fr 1fr;
            gap: 16px;
            align-items: start;
        }

        /* ===========================
           PANELS
           =========================== */
        .panel {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.06);
            overflow: hidden;
        }
        .panel-header {
            padding: 14px 18px;
            font-size: 15px;
            font-weight: 600;
            color: #44403c;
            border-bottom: 2px solid #f2a93b;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .panel-body {
            padding: 16px;
        }

        /* ===========================
           LEFT SIDEBAR: Block-Palette
           =========================== */
        .block-palette {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .palette-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 14px;
            background: #faf9f7;
            border: 1px solid #e7e5e4;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            color: #57534e;
            transition: all 0.15s;
        }
        .palette-btn:hover {
            background: #fff3e0;
            border-color: #f2a93b;
            color: #44403c;
        }
        .palette-btn .p-icon { font-size: 18px; }

        /* Global Settings */
        .settings-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 8px;
        }
        .setting-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .setting-item label {
            font-size: 11px;
            font-weight: 600;
            color: #a8a29e;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .setting-item input[type="text"],
        .setting-item input[type="number"],
        .setting-item select {
            padding: 7px 10px;
            border: 1px solid #d6d3d1;
            border-radius: 5px;
            font-size: 13px;
            transition: border-color 0.2s;
            width: 100%;
            background: #faf9f7;
            color: #44403c;
        }
        .setting-item input:focus,
        .setting-item select:focus {
            outline: none;
            border-color: #f2a93b;
        }
        .color-row {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .color-row input[type="color"] {
            width: 32px;
            height: 32px;
            border: 1px solid #d6d3d1;
            border-radius: 4px;
            cursor: pointer;
            padding: 2px;
        }
        .color-row input[type="text"] {
            flex: 1;
        }

        /* ===========================
           CENTER: Block-Editor
           =========================== */
        .blocks-list {
            min-height: 200px;
        }
        .block-empty {
            text-align: center;
            padding: 60px 20px;
            color: #a8a29e;
            font-size: 14px;
        }
        .block-empty .empty-icon { font-size: 48px; margin-bottom: 12px; }

        /* Single Block Card */
        .block-card {
            background: #fff;
            border: 1px solid #e7e5e4;
            border-radius: 8px;
            margin-bottom: 10px;
            overflow: hidden;
            transition: box-shadow 0.2s;
        }
        .block-card:hover {
            box-shadow: 0 2px 12px rgba(0,0,0,0.06);
        }
        .block-card.dragging {
            opacity: 0.5;
            border: 2px dashed #f2a93b;
        }
        .block-card-header {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 14px;
            background: #faf9f7;
            border-bottom: 1px solid #e7e5e4;
            cursor: grab;
        }
        .block-card-header:active { cursor: grabbing; }
        .block-drag-handle {
            color: #d6d3d1;
            font-size: 16px;
            cursor: grab;
        }
        .block-type-icon { font-size: 16px; }
        .block-type-label {
            flex: 1;
            font-size: 13px;
            font-weight: 600;
            color: #57534e;
        }
        .block-actions {
            display: flex;
            gap: 4px;
        }
        .block-btn {
            background: none;
            border: 1px solid transparent;
            border-radius: 4px;
            cursor: pointer;
            padding: 4px 8px;
            font-size: 14px;
            color: #a8a29e;
            transition: all 0.15s;
        }
        .block-btn:hover { background: #f5f3f0; color: #57534e; }
        .block-btn.btn-delete:hover { background: #fde8e8; color: #d32f2f; }

        /* Block Edit Form */
        .block-card-body {
            padding: 14px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .block-card-body.collapsed { display: none; }

        .field-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .field-group label {
            font-size: 11px;
            font-weight: 600;
            color: #a8a29e;
            text-transform: uppercase;
        }
        .field-group input[type="text"],
        .field-group input[type="number"],
        .field-group input[type="url"],
        .field-group textarea,
        .field-group select {
            padding: 8px 10px;
            border: 1px solid #d6d3d1;
            border-radius: 5px;
            font-size: 13px;
            font-family: inherit;
            transition: border-color 0.2s;
            background: #faf9f7;
            color: #44403c;
        }
        .field-group input:focus,
        .field-group textarea:focus,
        .field-group select:focus {
            outline: none;
            border-color: #f2a93b;
        }
        .field-group textarea { resize: vertical; min-height: 60px; }
        .field-row {
            display: flex;
            gap: 10px;
        }
        .field-row .field-group { flex: 1; }
        .field-hint {
            font-size: 11px;
            color: #a8a29e;
            margin-top: 2px;
        }

        /* ===========================
           RIGHT: Preview
           =========================== */
        .preview-panel {
            position: sticky;
            top: 20px;
        }
        .preview-toolbar {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 16px;
            border-bottom: 1px solid #e7e5e4;
        }
        .preview-toggle {
            display: flex;
            background: #f5f3f0;
            border-radius: 6px;
            overflow: hidden;
        }
        .preview-toggle-btn {
            padding: 6px 14px;
            font-size: 12px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            background: transparent;
            color: #a8a29e;
            transition: all 0.15s;
        }
        .preview-toggle-btn.active {
            background: #f2a93b;
            color: #fff;
        }
        .preview-size-label {
            font-size: 11px;
            color: #a8a29e;
            margin-left: auto;
        }
        .preview-container {
            background: #eae7e3;
            min-height: 500px;
            display: flex;
            justify-content: center;
            padding: 20px;
            overflow: auto;
            max-height: 80vh;
        }
        .preview-container iframe {
            border: none;
            background: #fff;
            box-shadow: 0 2px 12px rgba(0,0,0,0.15);
            transition: width 0.3s ease;
        }

        /* ===========================
           EXPORT BAR
           =========================== */
        .export-bar {
            background: #fff;
            border-radius: 8px;
            padding: 16px 20px;
            margin-top: 16px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.06);
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }
        .btn-export {
            background: #f2a93b;
            color: white;
            border: none;
            padding: 10px 22px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-export:hover {
            background: #e09930;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        .btn-secondary {
            background: #faf9f7;
            color: #78716c;
            border: 1px solid #d6d3d1;
            padding: 10px 22px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-secondary:hover {
            background: #f5f3f0;
            border-color: #a8a29e;
        }
        .export-spacer { flex: 1; }
        .template-size-info {
            font-size: 12px;
            color: #a8a29e;
        }
        .template-size-info.warn { color: #d32f2f; font-weight: 600; }

        /* ===========================
           RESPONSIVE
           =========================== */
        @media (max-width: 1200px) {
            .app-layout {
                grid-template-columns: 200px 1fr;
            }
            .preview-panel { position: static; }
        }
        @media (max-width: 800px) {
            .app-layout {
                grid-template-columns: 1fr;
            }
        }

        /* ===========================
           PHASE 2: Drop Zone Highlight
           =========================== */
        .block-card.drag-over {
            border-top: 3px solid #f2a93b;
            margin-top: -3px;
        }
        .blocks-list.drag-active .block-empty { display: none; }

        /* Stats Bar */
        .stats-bar {
            display: flex;
            gap: 16px;
            align-items: center;
            flex-wrap: wrap;
        }
        .stat-chip {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
            color: #78716c;
            background: #faf9f7;
            border: 1px solid #e7e5e4;
            padding: 4px 10px;
            border-radius: 4px;
        }
        .stat-chip.warn {
            background: #fef2f2;
            border-color: #fecaca;
            color: #dc2626;
            font-weight: 600;
        }
        .stat-chip.good {
            background: #f0fdf4;
            border-color: #bbf7d0;
            color: #16a34a;
        }

        /* ===========================
           PHASE 3: Palette Section Headers
           =========================== */
        .palette-section {
            font-size: 10px;
            font-weight: 700;
            color: #a8a29e;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 10px;
            margin-bottom: 2px;
            padding-left: 4px;
        }
        .palette-section:first-child { margin-top: 0; }

        /* Tracking row in link fields */
        .tracking-row {
            display: flex;
            gap: 6px;
            align-items: center;
            margin-top: 4px;
        }
        .tracking-row input {
            flex: 1;
            padding: 5px 8px;
            border: 1px solid #d6d3d1;
            border-radius: 4px;
            font-size: 11px;
            background: #faf9f7;
            color: #44403c;
        }
        .tracking-row input:focus {
            outline: none;
            border-color: #f2a93b;
        }
        .tracking-row label {
            font-size: 10px;
            color: #a8a29e;
            min-width: 55px;
        }
    </style>
</head>
<body>

<!-- Header -->
<header class="main-header">
    <a href="index.html" class="back-link">‚Üê Toolbox</a>
    <h1>üõ†Ô∏è Template Ersteller</h1>
</header>

<!-- Main Layout -->
<div class="app-layout">

    <!-- LEFT: Block-Palette + Settings -->
    <div class="sidebar-left">
        <div class="panel">
            <div class="panel-header">‚ûï Bausteine</div>
            <div class="panel-body block-palette">
                <div class="palette-section">Basis</div>
                <button class="palette-btn" onclick="addBlock('header-image')"><span class="p-icon">üñºÔ∏è</span> Header-Bild</button>
                <button class="palette-btn" onclick="addBlock('text')"><span class="p-icon">üìù</span> Textblock</button>
                <button class="palette-btn" onclick="addBlock('image')"><span class="p-icon">üèûÔ∏è</span> Bild</button>
                <button class="palette-btn" onclick="addBlock('button')"><span class="p-icon">üîò</span> Button / CTA</button>
                <button class="palette-btn" onclick="addBlock('spacer')"><span class="p-icon">‚ÜïÔ∏è</span> Trenner / Abstand</button>
                <button class="palette-btn" onclick="addBlock('footer')"><span class="p-icon">üìã</span> Footer</button>
                <div class="palette-section">Erweitert</div>
                <button class="palette-btn" onclick="addBlock('image-text')"><span class="p-icon">üñºÔ∏èüìù</span> Bild + Text</button>
                <button class="palette-btn" onclick="addBlock('columns')"><span class="p-icon">‚ñ•</span> Spalten (2/3)</button>
                <button class="palette-btn" onclick="addBlock('social')"><span class="p-icon">üåê</span> Social Media</button>
            </div>
        </div>

        <div class="panel" style="margin-top: 12px;">
            <div class="panel-header">‚öôÔ∏è Einstellungen</div>
            <div class="panel-body settings-group">
                <div class="setting-item">
                    <label>Title-Tag</label>
                    <input type="text" id="settingTitle" placeholder="z.B. Newsletter M√§rz 2026" oninput="updatePreview()">
                </div>
                <div class="setting-item">
                    <label>Template-Breite (px)</label>
                    <input type="number" id="settingWidth" value="600" min="400" max="800" oninput="updatePreview()">
                </div>
                <div class="setting-item">
                    <label>Seiten-Hintergrund</label>
                    <div class="color-row">
                        <input type="color" id="settingBgColor" value="#f4f4f4" oninput="syncColor('settingBgColor')">
                        <input type="text" id="settingBgColorText" value="#f4f4f4" oninput="syncColorText('settingBgColor')">
                    </div>
                </div>
                <div class="setting-item">
                    <label>Inhalts-Hintergrund</label>
                    <div class="color-row">
                        <input type="color" id="settingContentBg" value="#ffffff" oninput="syncColor('settingContentBg')">
                        <input type="text" id="settingContentBgText" value="#ffffff" oninput="syncColorText('settingContentBg')">
                    </div>
                </div>
                <div class="setting-item">
                    <label>Schriftart</label>
                    <select id="settingFont" onchange="updatePreview()">
                        <option value="Arial, Helvetica, sans-serif">Arial</option>
                        <option value="Helvetica, Arial, sans-serif">Helvetica</option>
                        <option value="Georgia, 'Times New Roman', serif">Georgia</option>
                        <option value="Verdana, Geneva, sans-serif">Verdana</option>
                        <option value="Tahoma, Geneva, sans-serif">Tahoma</option>
                        <option value="'Trebuchet MS', Helvetica, sans-serif">Trebuchet MS</option>
                        <option value="'Courier New', Courier, monospace">Courier New</option>
                    </select>
                </div>
                <div class="setting-item">
                    <label>Eigene Schriftart (optional)</label>
                    <input type="text" id="settingCustomFont" placeholder="z.B. NissanBrand" oninput="updatePreview()">
                    <span class="field-hint">Wird als Fallback mit der obigen Schrift kombiniert</span>
                </div>
                <div class="setting-item">
                    <label>Eigene Font-URL (optional)</label>
                    <input type="text" id="settingCustomFontUrl" placeholder="https://fonts.googleapis.com/css2?..." oninput="updatePreview()">
                    <span class="field-hint">Google Fonts oder andere Web-Font-URL</span>
                </div>
                <div class="setting-item">
                    <label>Template-Typ</label>
                    <select id="settingType" onchange="updatePreview()">
                        <option value="standard">Standard</option>
                        <option value="dpl">DPL</option>
                    </select>
                </div>
                <div class="setting-item">
                    <label>√ñffnerpixel</label>
                    <select id="settingPixel" onchange="updatePreview()">
                        <option value="placeholder">Platzhalter (Pixel wird sp√§ter eingesetzt)</option>
                        <option value="none">Kein √ñffnerpixel</option>
                    </select>
                </div>
                <div class="setting-item">
                    <label>Tracking-Platzhalter</label>
                    <select id="settingTracking" onchange="toggleTrackingFields()">
                        <option value="none">Keine (Links ohne UTM)</option>
                        <option value="utm">UTM-Parameter an Links anf√ºgen</option>
                    </select>
                </div>
                <div id="trackingFields" style="display:none;">
                    <div class="setting-item">
                        <label>utm_source</label>
                        <input type="text" id="settingUtmSource" placeholder="z.B. newsletter" oninput="updatePreview()">
                    </div>
                    <div class="setting-item">
                        <label>utm_medium</label>
                        <input type="text" id="settingUtmMedium" placeholder="z.B. email" oninput="updatePreview()">
                    </div>
                    <div class="setting-item">
                        <label>utm_campaign</label>
                        <input type="text" id="settingUtmCampaign" placeholder="z.B. maerz2026" oninput="updatePreview()">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- CENTER: Block Editor -->
    <div class="panel">
        <div class="panel-header">üìß Template-Aufbau</div>
        <div class="panel-body">
            <div id="blocksList" class="blocks-list">
                <div class="block-empty" id="emptyState">
                    <div class="empty-icon">üì≠</div>
                    Noch keine Bausteine hinzugef√ºgt.<br>
                    Klicke links auf einen Baustein, um zu starten.
                </div>
            </div>
        </div>
    </div>

    <!-- RIGHT: Preview -->
    <div class="panel preview-panel">
        <div class="panel-header">üëÅÔ∏è Vorschau</div>
        <div class="preview-toolbar">
            <div class="preview-toggle">
                <button class="preview-toggle-btn active" onclick="setPreviewMode('desktop')">üñ•Ô∏è Desktop</button>
                <button class="preview-toggle-btn" onclick="setPreviewMode('mobile')">üì± Mobil</button>
            </div>
            <span class="preview-size-label" id="previewSizeLabel">600px</span>
        </div>
        <div class="preview-container" id="previewContainer">
            <iframe id="previewFrame" style="width: 600px; min-height: 400px;"></iframe>
        </div>
    </div>
</div>

<!-- Export Bar -->
<div class="export-bar">
    <button class="btn-export" onclick="exportHtml()">üì• HTML exportieren</button>
    <button class="btn-secondary" onclick="saveTemplate()">üíæ Vorlage speichern</button>
    <button class="btn-secondary" onclick="loadTemplate()">üìÇ Vorlage laden</button>
    <button class="btn-secondary" onclick="exportTemplateFile()">üì§ Vorlage als Datei</button>
    <button class="btn-secondary" onclick="importTemplateFile()">üì• Vorlage importieren</button>
    <input type="file" id="importFileInput" accept=".json" style="display:none" onchange="handleImportFile(event)">
    <div class="export-spacer"></div>
    <div class="stats-bar">
        <span class="stat-chip" id="statBlocks">üì¶ 0 Bl√∂cke</span>
        <span class="stat-chip" id="statRatio">üìä Text/Bild: ‚Äì</span>
        <span class="stat-chip" id="statLinks">üîó 0 Links</span>
        <span class="template-size-info" id="templateSizeInfo"></span>
    </div>
</div>

<script>
// ===========================
// STATE
// ===========================
let blocks = [];
let blockIdCounter = 0;
let previewMode = 'desktop';
let dragSrcIndex = null;

// ===========================
// BLOCK DEFINITIONS
// ===========================
const BLOCK_DEFS = {
    'header-image': {
        icon: 'üñºÔ∏è',
        label: 'Header-Bild',
        defaults: { src: '', alt: 'Header', link: '', width: '100%' }
    },
    'text': {
        icon: 'üìù',
        label: 'Textblock',
        defaults: {
            heading: '', headingSize: '22', headingColor: '#333333',
            text: '', textSize: '15', textColor: '#555555',
            textAlign: 'left', paddingTop: '10', paddingBottom: '10',
            paddingLeft: '20', paddingRight: '20'
        }
    },
    'image': {
        icon: 'üèûÔ∏è',
        label: 'Bild',
        defaults: { src: '', alt: '', link: '', width: '100%', align: 'center' }
    },
    'button': {
        icon: 'üîò',
        label: 'Button / CTA',
        defaults: {
            text: 'Jetzt entdecken', link: '#', bgColor: '#f2a93b',
            textColor: '#ffffff', borderRadius: '5', fontSize: '16',
            paddingV: '12', paddingH: '30', align: 'center'
        }
    },
    'spacer': {
        icon: '‚ÜïÔ∏è',
        label: 'Trenner / Abstand',
        defaults: { height: '20', showLine: false, lineColor: '#e0e0e0' }
    },
    'footer': {
        icon: 'üìã',
        label: 'Footer',
        defaults: {
            text: 'Sie erhalten diese E-Mail, weil Sie sich f√ºr unseren Newsletter angemeldet haben.',
            unsubscribeText: 'Abmelden',
            unsubscribeLink: '#UNSUBSCRIBE#',
            imprintText: 'Impressum',
            imprintLink: '#',
            textColor: '#999999',
            bgColor: '#f8f8f8',
            fontSize: '12'
        }
    },
    'image-text': {
        icon: 'üñºÔ∏èüìù',
        label: 'Bild + Text',
        defaults: {
            imageSrc: '', imageAlt: '', imageLink: '',
            imageWidth: '200', imagePosition: 'left',
            heading: '', headingSize: '18', headingColor: '#333333',
            text: '', textSize: '14', textColor: '#555555',
            paddingTop: '15', paddingBottom: '15',
            paddingLeft: '20', paddingRight: '20'
        }
    },
    'columns': {
        icon: '‚ñ•',
        label: 'Spalten',
        defaults: {
            count: '2',
            col1Heading: '', col1Text: '', col1ImageSrc: '', col1ImageAlt: '', col1Link: '',
            col2Heading: '', col2Text: '', col2ImageSrc: '', col2ImageAlt: '', col2Link: '',
            col3Heading: '', col3Text: '', col3ImageSrc: '', col3ImageAlt: '', col3Link: '',
            headingSize: '16', headingColor: '#333333',
            textSize: '13', textColor: '#555555',
            gap: '20', paddingTop: '15', paddingBottom: '15'
        }
    },
    'social': {
        icon: 'üåê',
        label: 'Social Media',
        defaults: {
            align: 'center',
            iconSize: '32',
            gap: '10',
            facebook: '', instagram: '', linkedin: '',
            twitter: '', youtube: '', tiktok: '',
            website: '',
            paddingTop: '15', paddingBottom: '15',
            bgColor: ''
        }
    }
};

// ===========================
// ADD BLOCK
// ===========================
function addBlock(type) {
    const def = BLOCK_DEFS[type];
    if (!def) return;
    const block = {
        id: ++blockIdCounter,
        type: type,
        data: JSON.parse(JSON.stringify(def.defaults)),
        collapsed: false
    };
    blocks.push(block);
    renderBlocks();
    updatePreview();
}

// ===========================
// REMOVE BLOCK
// ===========================
function removeBlock(id) {
    blocks = blocks.filter(b => b.id !== id);
    renderBlocks();
    updatePreview();
}

// ===========================
// MOVE BLOCK
// ===========================
function moveBlock(id, dir) {
    const idx = blocks.findIndex(b => b.id === id);
    if (idx < 0) return;
    const newIdx = idx + dir;
    if (newIdx < 0 || newIdx >= blocks.length) return;
    [blocks[idx], blocks[newIdx]] = [blocks[newIdx], blocks[idx]];
    renderBlocks();
    updatePreview();
}

// ===========================
// TOGGLE BLOCK
// ===========================
function toggleBlock(id) {
    const block = blocks.find(b => b.id === id);
    if (block) block.collapsed = !block.collapsed;
    renderBlocks();
}

// ===========================
// DUPLICATE BLOCK
// ===========================
function duplicateBlock(id) {
    const block = blocks.find(b => b.id === id);
    if (!block) return;
    const newBlock = {
        id: ++blockIdCounter,
        type: block.type,
        data: JSON.parse(JSON.stringify(block.data)),
        collapsed: false
    };
    const idx = blocks.findIndex(b => b.id === id);
    blocks.splice(idx + 1, 0, newBlock);
    renderBlocks();
    updatePreview();
}

// ===========================
// UPDATE BLOCK DATA
// ===========================
function updateBlockData(id, key, value) {
    const block = blocks.find(b => b.id === id);
    if (block) {
        block.data[key] = value;
        updatePreview();
    }
}

// ===========================
// RENDER BLOCKS LIST
// ===========================
function renderBlocks() {
    const list = document.getElementById('blocksList');
    const empty = document.getElementById('emptyState');

    if (blocks.length === 0) {
        list.innerHTML = '';
        list.appendChild(createEmptyState());
        return;
    }

    list.innerHTML = '';
    blocks.forEach((block, index) => {
        const card = document.createElement('div');
        card.className = 'block-card';
        card.dataset.blockId = block.id;
        card.draggable = true;

        // Drag events
        card.addEventListener('dragstart', (e) => {
            dragSrcIndex = index;
            card.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        });
        card.addEventListener('dragend', () => {
            card.classList.remove('dragging');
            dragSrcIndex = null;
        });
        card.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
        });
        card.addEventListener('drop', (e) => {
            e.preventDefault();
            if (dragSrcIndex === null || dragSrcIndex === index) return;
            const moved = blocks.splice(dragSrcIndex, 1)[0];
            blocks.splice(index, 0, moved);
            dragSrcIndex = null;
            renderBlocks();
            updatePreview();
        });

        const def = BLOCK_DEFS[block.type];
        card.innerHTML = `
            <div class="block-card-header">
                <span class="block-drag-handle">‚†ø</span>
                <span class="block-type-icon">${def.icon}</span>
                <span class="block-type-label">${def.label}</span>
                <div class="block-actions">
                    <button class="block-btn" title="Nach oben" onclick="moveBlock(${block.id}, -1)">‚ñ≤</button>
                    <button class="block-btn" title="Nach unten" onclick="moveBlock(${block.id}, 1)">‚ñº</button>
                    <button class="block-btn" title="Duplizieren" onclick="duplicateBlock(${block.id})">üìã</button>
                    <button class="block-btn" title="${block.collapsed ? 'Aufklappen' : 'Zuklappen'}" onclick="toggleBlock(${block.id})">${block.collapsed ? '‚ñ∂' : '‚ñº'}</button>
                    <button class="block-btn btn-delete" title="L√∂schen" onclick="removeBlock(${block.id})">‚úï</button>
                </div>
            </div>
            <div class="block-card-body ${block.collapsed ? 'collapsed' : ''}">
                ${renderBlockFields(block)}
            </div>
        `;
        list.appendChild(card);
    });
}

function createEmptyState() {
    const div = document.createElement('div');
    div.className = 'block-empty';
    div.id = 'emptyState';
    div.innerHTML = '<div class="empty-icon">üì≠</div>Noch keine Bausteine hinzugef√ºgt.<br>Klicke links auf einen Baustein, um zu starten.';
    return div;
}

// ===========================
// RENDER BLOCK FIELDS
// ===========================
function renderBlockFields(block) {
    const d = block.data;
    const id = block.id;

    switch(block.type) {
        case 'header-image':
            return `
                <div class="field-group">
                    <label>Bild-URL</label>
                    <input type="url" value="${esc(d.src)}" placeholder="https://example.com/header.jpg" oninput="updateBlockData(${id},'src',this.value)">
                </div>
                <div class="field-row">
                    <div class="field-group">
                        <label>Alt-Text</label>
                        <input type="text" value="${esc(d.alt)}" placeholder="Beschreibung" oninput="updateBlockData(${id},'alt',this.value)">
                    </div>
                    <div class="field-group">
                        <label>Breite</label>
                        <input type="text" value="${esc(d.width)}" placeholder="100% oder 600" oninput="updateBlockData(${id},'width',this.value)">
                    </div>
                </div>
                <div class="field-group">
                    <label>Link (optional)</label>
                    <input type="url" value="${esc(d.link)}" placeholder="https://..." oninput="updateBlockData(${id},'link',this.value)">
                </div>
            `;

        case 'text':
            return `
                <div class="field-group">
                    <label>√úberschrift (optional)</label>
                    <input type="text" value="${esc(d.heading)}" placeholder="z.B. Willkommen!" oninput="updateBlockData(${id},'heading',this.value)">
                </div>
                <div class="field-row">
                    <div class="field-group">
                        <label>√úberschrift-Gr√∂√üe (px)</label>
                        <input type="number" value="${d.headingSize}" min="12" max="48" oninput="updateBlockData(${id},'headingSize',this.value)">
                    </div>
                    <div class="field-group">
                        <label>√úberschrift-Farbe</label>
                        <div class="color-row">
                            <input type="color" value="${d.headingColor}" oninput="updateBlockData(${id},'headingColor',this.value)">
                            <input type="text" value="${esc(d.headingColor)}" oninput="updateBlockData(${id},'headingColor',this.value)" style="flex:1">
                        </div>
                    </div>
                </div>
                <div class="field-group">
                    <label>Text</label>
                    <textarea rows="4" placeholder="Ihr Text hier..." oninput="updateBlockData(${id},'text',this.value)">${esc(d.text)}</textarea>
                    <span class="field-hint">F√ºr Zeilenumbr√ºche einfach Enter dr√ºcken. F√ºr Links: &lt;a href="URL"&gt;Text&lt;/a&gt;</span>
                </div>
                <div class="field-row">
                    <div class="field-group">
                        <label>Text-Gr√∂√üe (px)</label>
                        <input type="number" value="${d.textSize}" min="10" max="36" oninput="updateBlockData(${id},'textSize',this.value)">
                    </div>
                    <div class="field-group">
                        <label>Text-Farbe</label>
                        <div class="color-row">
                            <input type="color" value="${d.textColor}" oninput="updateBlockData(${id},'textColor',this.value)">
                            <input type="text" value="${esc(d.textColor)}" oninput="updateBlockData(${id},'textColor',this.value)" style="flex:1">
                        </div>
                    </div>
                    <div class="field-group">
                        <label>Ausrichtung</label>
                        <select onchange="updateBlockData(${id},'textAlign',this.value)">
                            <option value="left" ${d.textAlign==='left'?'selected':''}>Links</option>
                            <option value="center" ${d.textAlign==='center'?'selected':''}>Zentriert</option>
                            <option value="right" ${d.textAlign==='right'?'selected':''}>Rechts</option>
                        </select>
                    </div>
                </div>
                <div class="field-row">
                    <div class="field-group">
                        <label>Abstand oben (px)</label>
                        <input type="number" value="${d.paddingTop}" min="0" oninput="updateBlockData(${id},'paddingTop',this.value)">
                    </div>
                    <div class="field-group">
                        <label>Abstand unten (px)</label>
                        <input type="number" value="${d.paddingBottom}" min="0" oninput="updateBlockData(${id},'paddingBottom',this.value)">
                    </div>
                    <div class="field-group">
                        <label>Abstand links (px)</label>
                        <input type="number" value="${d.paddingLeft}" min="0" oninput="updateBlockData(${id},'paddingLeft',this.value)">
                    </div>
                    <div class="field-group">
                        <label>Abstand rechts (px)</label>
                        <input type="number" value="${d.paddingRight}" min="0" oninput="updateBlockData(${id},'paddingRight',this.value)">
                    </div>
                </div>
            `;

        case 'image':
            return `
                <div class="field-group">
                    <label>Bild-URL</label>
                    <input type="url" value="${esc(d.src)}" placeholder="https://example.com/bild.jpg" oninput="updateBlockData(${id},'src',this.value)">
                </div>
                <div class="field-row">
                    <div class="field-group">
                        <label>Alt-Text</label>
                        <input type="text" value="${esc(d.alt)}" placeholder="Bildbeschreibung" oninput="updateBlockData(${id},'alt',this.value)">
                    </div>
                    <div class="field-group">
                        <label>Breite</label>
                        <input type="text" value="${esc(d.width)}" placeholder="100% oder 560" oninput="updateBlockData(${id},'width',this.value)">
                    </div>
                    <div class="field-group">
                        <label>Ausrichtung</label>
                        <select onchange="updateBlockData(${id},'align',this.value)">
                            <option value="left" ${d.align==='left'?'selected':''}>Links</option>
                            <option value="center" ${d.align==='center'?'selected':''}>Zentriert</option>
                            <option value="right" ${d.align==='right'?'selected':''}>Rechts</option>
                        </select>
                    </div>
                </div>
                <div class="field-group">
                    <label>Link (optional)</label>
                    <input type="url" value="${esc(d.link)}" placeholder="https://..." oninput="updateBlockData(${id},'link',this.value)">
                </div>
            `;

        case 'button':
            return `
                <div class="field-row">
                    <div class="field-group">
                        <label>Button-Text</label>
                        <input type="text" value="${esc(d.text)}" placeholder="Jetzt kaufen" oninput="updateBlockData(${id},'text',this.value)">
                    </div>
                    <div class="field-group">
                        <label>Link</label>
                        <input type="url" value="${esc(d.link)}" placeholder="https://..." oninput="updateBlockData(${id},'link',this.value)">
                    </div>
                </div>
                <div class="field-row">
                    <div class="field-group">
                        <label>Button-Farbe</label>
                        <div class="color-row">
                            <input type="color" value="${d.bgColor}" oninput="updateBlockData(${id},'bgColor',this.value)">
                            <input type="text" value="${esc(d.bgColor)}" oninput="updateBlockData(${id},'bgColor',this.value)" style="flex:1">
                        </div>
                    </div>
                    <div class="field-group">
                        <label>Schriftfarbe</label>
                        <div class="color-row">
                            <input type="color" value="${d.textColor}" oninput="updateBlockData(${id},'textColor',this.value)">
                            <input type="text" value="${esc(d.textColor)}" oninput="updateBlockData(${id},'textColor',this.value)" style="flex:1">
                        </div>
                    </div>
                </div>
                <div class="field-row">
                    <div class="field-group">
                        <label>Rundung (px)</label>
                        <input type="number" value="${d.borderRadius}" min="0" max="50" oninput="updateBlockData(${id},'borderRadius',this.value)">
                    </div>
                    <div class="field-group">
                        <label>Schriftgr√∂√üe (px)</label>
                        <input type="number" value="${d.fontSize}" min="10" max="30" oninput="updateBlockData(${id},'fontSize',this.value)">
                    </div>
                    <div class="field-group">
                        <label>Ausrichtung</label>
                        <select onchange="updateBlockData(${id},'align',this.value)">
                            <option value="left" ${d.align==='left'?'selected':''}>Links</option>
                            <option value="center" ${d.align==='center'?'selected':''}>Zentriert</option>
                            <option value="right" ${d.align==='right'?'selected':''}>Rechts</option>
                        </select>
                    </div>
                </div>
                <div class="field-row">
                    <div class="field-group">
                        <label>Innenabstand vertikal (px)</label>
                        <input type="number" value="${d.paddingV}" min="4" max="30" oninput="updateBlockData(${id},'paddingV',this.value)">
                    </div>
                    <div class="field-group">
                        <label>Innenabstand horizontal (px)</label>
                        <input type="number" value="${d.paddingH}" min="8" max="60" oninput="updateBlockData(${id},'paddingH',this.value)">
                    </div>
                </div>
            `;

        case 'spacer':
            return `
                <div class="field-row">
                    <div class="field-group">
                        <label>H√∂he (px)</label>
                        <input type="number" value="${d.height}" min="5" max="100" oninput="updateBlockData(${id},'height',this.value)">
                    </div>
                    <div class="field-group">
                        <label>Trennlinie anzeigen?</label>
                        <select onchange="updateBlockData(${id},'showLine',this.value==='true')">
                            <option value="false" ${!d.showLine?'selected':''}>Nein ‚Äì nur Abstand</option>
                            <option value="true" ${d.showLine?'selected':''}>Ja ‚Äì mit Linie</option>
                        </select>
                    </div>
                    <div class="field-group">
                        <label>Linien-Farbe</label>
                        <div class="color-row">
                            <input type="color" value="${d.lineColor}" oninput="updateBlockData(${id},'lineColor',this.value)">
                            <input type="text" value="${esc(d.lineColor)}" oninput="updateBlockData(${id},'lineColor',this.value)" style="flex:1">
                        </div>
                    </div>
                </div>
            `;

        case 'footer':
            return `
                <div class="field-group">
                    <label>Footer-Text</label>
                    <textarea rows="3" oninput="updateBlockData(${id},'text',this.value)">${esc(d.text)}</textarea>
                </div>
                <div class="field-row">
                    <div class="field-group">
                        <label>Abmelde-Text</label>
                        <input type="text" value="${esc(d.unsubscribeText)}" oninput="updateBlockData(${id},'unsubscribeText',this.value)">
                    </div>
                    <div class="field-group">
                        <label>Abmelde-Link</label>
                        <input type="text" value="${esc(d.unsubscribeLink)}" placeholder="#UNSUBSCRIBE#" oninput="updateBlockData(${id},'unsubscribeLink',this.value)">
                    </div>
                </div>
                <div class="field-row">
                    <div class="field-group">
                        <label>Impressum-Text</label>
                        <input type="text" value="${esc(d.imprintText)}" oninput="updateBlockData(${id},'imprintText',this.value)">
                    </div>
                    <div class="field-group">
                        <label>Impressum-Link</label>
                        <input type="url" value="${esc(d.imprintLink)}" oninput="updateBlockData(${id},'imprintLink',this.value)">
                    </div>
                </div>
                <div class="field-row">
                    <div class="field-group">
                        <label>Schriftfarbe</label>
                        <div class="color-row">
                            <input type="color" value="${d.textColor}" oninput="updateBlockData(${id},'textColor',this.value)">
                            <input type="text" value="${esc(d.textColor)}" oninput="updateBlockData(${id},'textColor',this.value)" style="flex:1">
                        </div>
                    </div>
                    <div class="field-group">
                        <label>Hintergrund</label>
                        <div class="color-row">
                            <input type="color" value="${d.bgColor}" oninput="updateBlockData(${id},'bgColor',this.value)">
                            <input type="text" value="${esc(d.bgColor)}" oninput="updateBlockData(${id},'bgColor',this.value)" style="flex:1">
                        </div>
                    </div>
                    <div class="field-group">
                        <label>Schriftgr√∂√üe (px)</label>
                        <input type="number" value="${d.fontSize}" min="9" max="16" oninput="updateBlockData(${id},'fontSize',this.value)">
                    </div>
                </div>
            `;

        case 'image-text':
            return `
                <div class="field-row">
                    <div class="field-group">
                        <label>Bild-Position</label>
                        <select onchange="updateBlockData(${id},'imagePosition',this.value)">
                            <option value="left" ${d.imagePosition==='left'?'selected':''}>Bild links, Text rechts</option>
                            <option value="right" ${d.imagePosition==='right'?'selected':''}>Bild rechts, Text links</option>
                        </select>
                    </div>
                    <div class="field-group">
                        <label>Bildbreite (px)</label>
                        <input type="number" value="${d.imageWidth}" min="100" max="400" oninput="updateBlockData(${id},'imageWidth',this.value)">
                    </div>
                </div>
                <div class="field-group">
                    <label>Bild-URL</label>
                    <input type="url" value="${esc(d.imageSrc)}" placeholder="https://example.com/bild.jpg" oninput="updateBlockData(${id},'imageSrc',this.value)">
                </div>
                <div class="field-row">
                    <div class="field-group">
                        <label>Alt-Text</label>
                        <input type="text" value="${esc(d.imageAlt)}" oninput="updateBlockData(${id},'imageAlt',this.value)">
                    </div>
                    <div class="field-group">
                        <label>Bild-Link (optional)</label>
                        <input type="url" value="${esc(d.imageLink)}" oninput="updateBlockData(${id},'imageLink',this.value)">
                    </div>
                </div>
                <div class="field-group">
                    <label>√úberschrift (optional)</label>
                    <input type="text" value="${esc(d.heading)}" oninput="updateBlockData(${id},'heading',this.value)">
                </div>
                <div class="field-group">
                    <label>Text</label>
                    <textarea rows="3" oninput="updateBlockData(${id},'text',this.value)">${esc(d.text)}</textarea>
                </div>
                <div class="field-row">
                    <div class="field-group">
                        <label>√úberschrift-Farbe</label>
                        <div class="color-row">
                            <input type="color" value="${d.headingColor}" oninput="updateBlockData(${id},'headingColor',this.value)">
                            <input type="text" value="${esc(d.headingColor)}" oninput="updateBlockData(${id},'headingColor',this.value)" style="flex:1">
                        </div>
                    </div>
                    <div class="field-group">
                        <label>Text-Farbe</label>
                        <div class="color-row">
                            <input type="color" value="${d.textColor}" oninput="updateBlockData(${id},'textColor',this.value)">
                            <input type="text" value="${esc(d.textColor)}" oninput="updateBlockData(${id},'textColor',this.value)" style="flex:1">
                        </div>
                    </div>
                </div>
            `;

        case 'columns': {
            const count = parseInt(d.count) || 2;
            let colFields = '';
            for (let i = 1; i <= count; i++) {
                colFields += `
                <div style="background:#faf9f7; border:1px solid #e7e5e4; border-radius:6px; padding:10px; margin-bottom:8px;">
                    <div style="font-size:12px; font-weight:600; color:#78716c; margin-bottom:8px;">Spalte ${i}</div>
                    <div class="field-group">
                        <label>Bild-URL (optional)</label>
                        <input type="url" value="${esc(d['col'+i+'ImageSrc'])}" placeholder="https://..." oninput="updateBlockData(${id},'col${i}ImageSrc',this.value)">
                    </div>
                    <div class="field-group">
                        <label>√úberschrift</label>
                        <input type="text" value="${esc(d['col'+i+'Heading'])}" oninput="updateBlockData(${id},'col${i}Heading',this.value)">
                    </div>
                    <div class="field-group">
                        <label>Text</label>
                        <textarea rows="2" oninput="updateBlockData(${id},'col${i}Text',this.value)">${esc(d['col'+i+'Text'])}</textarea>
                    </div>
                    <div class="field-group">
                        <label>Link (optional)</label>
                        <input type="url" value="${esc(d['col'+i+'Link'])}" oninput="updateBlockData(${id},'col${i}Link',this.value)">
                    </div>
                </div>`;
            }
            return `
                <div class="field-row">
                    <div class="field-group">
                        <label>Anzahl Spalten</label>
                        <select onchange="updateBlockData(${id},'count',this.value); renderBlocks();">
                            <option value="2" ${d.count==='2'?'selected':''}>2 Spalten</option>
                            <option value="3" ${d.count==='3'?'selected':''}>3 Spalten</option>
                        </select>
                    </div>
                    <div class="field-group">
                        <label>Abstand zwischen Spalten (px)</label>
                        <input type="number" value="${d.gap}" min="0" max="40" oninput="updateBlockData(${id},'gap',this.value)">
                    </div>
                </div>
                <div class="field-row">
                    <div class="field-group">
                        <label>√úberschrift-Farbe</label>
                        <div class="color-row">
                            <input type="color" value="${d.headingColor}" oninput="updateBlockData(${id},'headingColor',this.value)">
                            <input type="text" value="${esc(d.headingColor)}" oninput="updateBlockData(${id},'headingColor',this.value)" style="flex:1">
                        </div>
                    </div>
                    <div class="field-group">
                        <label>Text-Farbe</label>
                        <div class="color-row">
                            <input type="color" value="${d.textColor}" oninput="updateBlockData(${id},'textColor',this.value)">
                            <input type="text" value="${esc(d.textColor)}" oninput="updateBlockData(${id},'textColor',this.value)" style="flex:1">
                        </div>
                    </div>
                </div>
                ${colFields}
            `;
        }

        case 'social':
            return `
                <div class="field-row">
                    <div class="field-group">
                        <label>Ausrichtung</label>
                        <select onchange="updateBlockData(${id},'align',this.value)">
                            <option value="left" ${d.align==='left'?'selected':''}>Links</option>
                            <option value="center" ${d.align==='center'?'selected':''}>Zentriert</option>
                            <option value="right" ${d.align==='right'?'selected':''}>Rechts</option>
                        </select>
                    </div>
                    <div class="field-group">
                        <label>Icon-Gr√∂√üe (px)</label>
                        <input type="number" value="${d.iconSize}" min="20" max="64" oninput="updateBlockData(${id},'iconSize',this.value)">
                    </div>
                    <div class="field-group">
                        <label>Abstand (px)</label>
                        <input type="number" value="${d.gap}" min="4" max="30" oninput="updateBlockData(${id},'gap',this.value)">
                    </div>
                </div>
                <span class="field-hint" style="margin-bottom:8px; display:block;">Nur ausgef√ºllte Felder werden angezeigt. URL leer lassen = Icon wird nicht angezeigt.</span>
                <div class="field-row">
                    <div class="field-group">
                        <label>Facebook</label>
                        <input type="url" value="${esc(d.facebook)}" placeholder="https://facebook.com/..." oninput="updateBlockData(${id},'facebook',this.value)">
                    </div>
                    <div class="field-group">
                        <label>Instagram</label>
                        <input type="url" value="${esc(d.instagram)}" placeholder="https://instagram.com/..." oninput="updateBlockData(${id},'instagram',this.value)">
                    </div>
                </div>
                <div class="field-row">
                    <div class="field-group">
                        <label>LinkedIn</label>
                        <input type="url" value="${esc(d.linkedin)}" placeholder="https://linkedin.com/..." oninput="updateBlockData(${id},'linkedin',this.value)">
                    </div>
                    <div class="field-group">
                        <label>X / Twitter</label>
                        <input type="url" value="${esc(d.twitter)}" placeholder="https://x.com/..." oninput="updateBlockData(${id},'twitter',this.value)">
                    </div>
                </div>
                <div class="field-row">
                    <div class="field-group">
                        <label>YouTube</label>
                        <input type="url" value="${esc(d.youtube)}" placeholder="https://youtube.com/..." oninput="updateBlockData(${id},'youtube',this.value)">
                    </div>
                    <div class="field-group">
                        <label>TikTok</label>
                        <input type="url" value="${esc(d.tiktok)}" placeholder="https://tiktok.com/..." oninput="updateBlockData(${id},'tiktok',this.value)">
                    </div>
                </div>
                <div class="field-group">
                    <label>Website</label>
                    <input type="url" value="${esc(d.website)}" placeholder="https://www.example.com" oninput="updateBlockData(${id},'website',this.value)">
                </div>
                <div class="field-group">
                    <label>Hintergrundfarbe (optional)</label>
                    <div class="color-row">
                        <input type="color" value="${d.bgColor || '#ffffff'}" oninput="updateBlockData(${id},'bgColor',this.value)">
                        <input type="text" value="${esc(d.bgColor)}" placeholder="leer = transparent" oninput="updateBlockData(${id},'bgColor',this.value)" style="flex:1">
                    </div>
                </div>
            `;

        default:
            return '<p>Unbekannter Block-Typ</p>';
    }
}

// ===========================
// HELPER: Escape HTML
// ===========================
function esc(str) {
    if (!str) return '';
    return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// ===========================
// COLOR SYNC HELPERS
// ===========================
function syncColor(baseId) {
    const picker = document.getElementById(baseId);
    const text = document.getElementById(baseId + 'Text');
    if (picker && text) {
        text.value = picker.value;
    }
    updatePreview();
}
function syncColorText(baseId) {
    const picker = document.getElementById(baseId);
    const text = document.getElementById(baseId + 'Text');
    if (picker && text && /^#[0-9a-fA-F]{6}$/.test(text.value)) {
        picker.value = text.value;
    }
    updatePreview();
}

// ===========================
// PREVIEW MODE
// ===========================
function setPreviewMode(mode) {
    previewMode = mode;
    document.querySelectorAll('.preview-toggle-btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');

    const frame = document.getElementById('previewFrame');
    const label = document.getElementById('previewSizeLabel');
    const width = document.getElementById('settingWidth').value || 600;

    if (mode === 'desktop') {
        frame.style.width = width + 'px';
        label.textContent = width + 'px';
    } else {
        frame.style.width = '375px';
        label.textContent = '375px (Mobil)';
    }
    updatePreview();
}

// ===========================
// GENERATE EMAIL HTML
// ===========================
function generateEmailHtml() {
    const title = document.getElementById('settingTitle').value || 'Newsletter';
    const width = document.getElementById('settingWidth').value || 600;
    const bgColor = document.getElementById('settingBgColorText').value || '#f4f4f4';
    const contentBg = document.getElementById('settingContentBgText').value || '#ffffff';
    const font = document.getElementById('settingFont').value;
    const customFont = document.getElementById('settingCustomFont').value;
    const customFontUrl = document.getElementById('settingCustomFontUrl').value;
    const templateType = document.getElementById('settingType').value;

    // Build font-family string
    let fontFamily = font;
    if (customFont.trim()) {
        fontFamily = "'" + customFont.trim() + "', " + font;
    }

    // Generate block HTML
    let blocksHtml = '';
    blocks.forEach(block => {
        blocksHtml += generateBlockHtml(block, width, fontFamily);
    });

    // Custom font link
    let fontLink = '';
    if (customFontUrl.trim()) {
        fontLink = `<link href="${esc(customFontUrl.trim())}" rel="stylesheet" type="text/css">`;
    }

    // Responsive media queries
    const mediaQueries = `
    <style type="text/css">
        @media screen and (max-width: ${width}px) {
            table[class="responsive-table"] { width: 100% !important; }
            td[class="responsive-cell"] { width: 100% !important; display: block !important; padding-right: 0 !important; }
            img[class="responsive-img"] { width: 100% !important; height: auto !important; }
        }
    </style>`;

    // √ñffnerpixel
    const pixelSetting = document.getElementById('settingPixel').value;
    let trackingPixel = '';
    if (pixelSetting === 'placeholder') {
        trackingPixel = '\n    <!-- √ñffnerpixel / Tracking Pixel -->\n    <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="" width="1" height="1" border="0" style="display:none;height:1px;width:1px;">';
    }

    // DPL specific
    let dplWrapperStart = '';
    let dplWrapperEnd = '';
    if (templateType === 'dpl') {
        dplWrapperStart = `
<!--[if mso]>
<div style="background-color: #6B140F;">
<![endif]-->
<div style="background-color: #6B140F;">`;
        dplWrapperEnd = `
</div>
<!--[if mso]>
</div>
<![endif]-->`;
    }

    const html = `<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:v="urn:schemas-microsoft-com:vml" xmlns:o="urn:schemas-microsoft-com:office:office" lang="de" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="color-scheme" content="light dark">
    <meta name="supported-color-schemes" content="light dark">
    <title>${esc(title)}</title>
    <!--[if mso]>
    <noscript>
        <xml>
            <o:OfficeDocumentSettings>
                <o:PixelsPerInch>96</o:PixelsPerInch>
            </o:OfficeDocumentSettings>
        </xml>
    </noscript>
    <![endif]-->
    ${fontLink}
    <style type="text/css">
        body, table, td, a { -webkit-text-size-adjust: 100%; -ms-text-size-adjust: 100%; }
        table, td { mso-table-lspace: 0pt; mso-table-rspace: 0pt; }
        img { -ms-interpolation-mode: bicubic; border: 0; height: auto; line-height: 100%; outline: none; text-decoration: none; }
        body { margin: 0; padding: 0; width: 100% !important; }
        a[x-apple-data-detectors] { color: inherit !important; text-decoration: none !important; font-size: inherit !important; font-family: inherit !important; font-weight: inherit !important; line-height: inherit !important; }
        @media (prefers-color-scheme: dark) {
            body, table, td { background-color: #1a1a1a !important; }
        }
    </style>
    ${mediaQueries}
</head>
<body style="margin: 0; padding: 0; background-color: ${bgColor}; font-family: ${fontFamily};">
${dplWrapperStart}
    <!-- HEADER PLACEHOLDER -->

    <!-- Email Container -->
    <table role="presentation" cellpadding="0" cellspacing="0" border="0" width="100%" style="background-color: ${bgColor};">
        <tr>
            <td align="center" style="padding: 20px 0;">
                <table role="presentation" class="responsive-table" cellpadding="0" cellspacing="0" border="0" width="${width}" style="max-width: ${width}px; background-color: ${contentBg};">
${blocksHtml}
                </table>
            </td>
        </tr>
    </table>

    <!-- Tracking Pixel Placeholder -->
    ${trackingPixel}

    <!-- FOOTER PLACEHOLDER -->
${dplWrapperEnd}
</body>
</html>`;

    return html;
}

// ===========================
// GENERATE SINGLE BLOCK HTML
// ===========================
function generateBlockHtml(block, width, fontFamily) {
    const d = block.data;

    switch(block.type) {
        case 'header-image': {
            const imgWidth = d.width.includes('%') ? width : d.width;
            const widthAttr = d.width.includes('%') ? '100%' : d.width;
            let imgTag = `<img src="${esc(d.src || 'https://via.placeholder.com/' + width + 'x200/f2a93b/ffffff?text=Header+Bild')}" alt="${esc(d.alt)}" width="${widthAttr}" class="responsive-img" style="display: block; width: ${d.width.includes('%') ? '100%' : d.width + 'px'}; max-width: 100%; height: auto;" border="0">`;
            if (d.link) {
                imgTag = `<a href="${esc(appendUtm(d.link))}" target="_blank">${imgTag}</a>`;
            }
            return `
                    <tr>
                        <td align="center" style="padding: 0; font-size: 0; line-height: 0;">
                            ${imgTag}
                        </td>
                    </tr>`;
        }

        case 'text': {
            let content = '';
            if (d.heading) {
                content += `<h1 style="margin: 0 0 10px 0; font-family: ${fontFamily}; font-size: ${d.headingSize}px; font-weight: 700; color: ${d.headingColor}; line-height: 1.3;">${escHtml(d.heading)}</h1>`;
            }
            if (d.text) {
                const paragraphs = d.text.split('\n').filter(p => p.trim() !== '');
                paragraphs.forEach(p => {
                    content += `<p style="margin: 0 0 12px 0; font-family: ${fontFamily}; font-size: ${d.textSize}px; color: ${d.textColor}; line-height: 1.6;">${escHtml(p)}</p>`;
                });
            }
            return `
                    <tr>
                        <td style="padding: ${d.paddingTop}px ${d.paddingRight}px ${d.paddingBottom}px ${d.paddingLeft}px; text-align: ${d.textAlign}; font-family: ${fontFamily};">
                            ${content}
                        </td>
                    </tr>`;
        }

        case 'image': {
            const imgWidth = d.width.includes('%') ? width : d.width;
            const widthAttr = d.width.includes('%') ? '100%' : d.width;
            let imgTag = `<img src="${esc(d.src || 'https://via.placeholder.com/' + width + 'x300/cccccc/666666?text=Bild')}" alt="${esc(d.alt)}" width="${widthAttr}" class="responsive-img" style="display: block; width: ${d.width.includes('%') ? '100%' : d.width + 'px'}; max-width: 100%; height: auto;" border="0">`;
            if (d.link) {
                imgTag = `<a href="${esc(appendUtm(d.link))}" target="_blank">${imgTag}</a>`;
            }
            return `
                    <tr>
                        <td align="${d.align}" style="padding: 10px 20px; font-size: 0; line-height: 0;">
                            ${imgTag}
                        </td>
                    </tr>`;
        }

        case 'button': {
            // Table-based button for Outlook compatibility
            return `
                    <tr>
                        <td align="${d.align}" style="padding: 15px 20px;">
                            <table role="presentation" cellpadding="0" cellspacing="0" border="0">
                                <tr>
                                    <td align="center" style="background-color: ${d.bgColor}; border-radius: ${d.borderRadius}px; padding: ${d.paddingV}px ${d.paddingH}px;">
                                        <!--[if mso]>
                                        <v:roundrect xmlns:v="urn:schemas-microsoft-com:vml" xmlns:w="urn:schemas-microsoft-com:office:word" href="${esc(appendUtm(d.link))}" style="height:auto;v-text-anchor:middle;width:auto;" arcsize="${Math.round(d.borderRadius / 40 * 100)}%" fillcolor="${d.bgColor}" stroke="false">
                                        <w:anchorlock/>
                                        <center style="font-family:${fontFamily};font-size:${d.fontSize}px;color:${d.textColor};font-weight:bold;">
                                            ${esc(d.text)}
                                        </center>
                                        </v:roundrect>
                                        <![endif]-->
                                        <!--[if !mso]><!-->
                                        <a href="${esc(appendUtm(d.link))}" target="_blank" style="display: inline-block; font-family: ${fontFamily}; font-size: ${d.fontSize}px; font-weight: bold; color: ${d.textColor}; text-decoration: none; line-height: 1;">
                                            ${esc(d.text)}
                                        </a>
                                        <!--<![endif]-->
                                    </td>
                                </tr>
                            </table>
                        </td>
                    </tr>`;
        }

        case 'spacer': {
            if (d.showLine) {
                return `
                    <tr>
                        <td style="padding: ${Math.floor(d.height/2)}px 20px;">
                            <table role="presentation" cellpadding="0" cellspacing="0" border="0" width="100%">
                                <tr>
                                    <td style="border-top: 1px solid ${d.lineColor}; font-size: 0; line-height: 0;">&nbsp;</td>
                                </tr>
                            </table>
                        </td>
                    </tr>`;
            }
            return `
                    <tr>
                        <td style="padding: 0; height: ${d.height}px; font-size: 0; line-height: 0;">&nbsp;</td>
                    </tr>`;
        }

        case 'footer': {
            return `
                    <tr>
                        <td style="padding: 20px 30px; background-color: ${d.bgColor}; text-align: center; font-family: ${fontFamily};">
                            <p style="margin: 0 0 10px 0; font-size: ${d.fontSize}px; color: ${d.textColor}; line-height: 1.5;">${escHtml(d.text)}</p>
                            <p style="margin: 0; font-size: ${d.fontSize}px; color: ${d.textColor}; line-height: 1.5;">
                                <a href="${esc(appendUtm(d.unsubscribeLink))}" style="color: ${d.textColor}; text-decoration: underline;">${esc(d.unsubscribeText)}</a>
                                &nbsp;|&nbsp;
                                <a href="${esc(appendUtm(d.imprintLink))}" style="color: ${d.textColor}; text-decoration: underline;">${esc(d.imprintText)}</a>
                            </p>
                        </td>
                    </tr>`;
        }

        case 'image-text': {
            const imgW = parseInt(d.imageWidth) || 200;
            const textW = parseInt(width) - imgW - 40; // 40 for padding
            const placeholderImg = `https://via.placeholder.com/${imgW}x${imgW}/cccccc/666666?text=Bild`;
            let imgCell = `
                <td class="responsive-cell" width="${imgW}" valign="top" style="padding: 0; width: ${imgW}px;">
                    ${d.imageLink ? '<a href="' + esc(appendUtm(d.imageLink)) + '" target="_blank">' : ''}
                    <img src="${esc(d.imageSrc || placeholderImg)}" alt="${esc(d.imageAlt)}" width="${imgW}" class="responsive-img" style="display: block; width: ${imgW}px; max-width: 100%; height: auto;" border="0">
                    ${d.imageLink ? '</a>' : ''}
                </td>`;
            let textContent = '';
            if (d.heading) {
                textContent += `<h2 style="margin: 0 0 8px 0; font-family: ${fontFamily}; font-size: ${d.headingSize}px; font-weight: 700; color: ${d.headingColor}; line-height: 1.3;">${escHtml(d.heading)}</h2>`;
            }
            if (d.text) {
                d.text.split('\n').filter(p => p.trim()).forEach(p => {
                    textContent += `<p style="margin: 0 0 10px 0; font-family: ${fontFamily}; font-size: ${d.textSize}px; color: ${d.textColor}; line-height: 1.5;">${escHtml(p)}</p>`;
                });
            }
            let textCell = `
                <td class="responsive-cell" valign="top" style="padding: 10px 15px; font-family: ${fontFamily};">
                    ${textContent}
                </td>`;
            const leftCell = d.imagePosition === 'left' ? imgCell : textCell;
            const rightCell = d.imagePosition === 'left' ? textCell : imgCell;
            return `
                    <tr>
                        <td style="padding: ${d.paddingTop}px ${d.paddingRight}px ${d.paddingBottom}px ${d.paddingLeft}px;">
                            <table role="presentation" class="responsive-table" cellpadding="0" cellspacing="0" border="0" width="100%">
                                <tr>
                                    ${leftCell}
                                    ${rightCell}
                                </tr>
                            </table>
                        </td>
                    </tr>`;
        }

        case 'columns': {
            const count = parseInt(d.count) || 2;
            const gapPx = parseInt(d.gap) || 20;
            const colWidth = Math.floor((parseInt(width) - 40 - (gapPx * (count - 1))) / count);
            let colsHtml = '';
            for (let i = 1; i <= count; i++) {
                const heading = d['col' + i + 'Heading'] || '';
                const text = d['col' + i + 'Text'] || '';
                const imgSrc = d['col' + i + 'ImageSrc'] || '';
                const imgAlt = d['col' + i + 'ImageAlt'] || '';
                const link = d['col' + i + 'Link'] || '';
                let cellContent = '';
                if (imgSrc) {
                    let img = `<img src="${esc(imgSrc)}" alt="${esc(imgAlt)}" width="${colWidth}" class="responsive-img" style="display: block; width: 100%; max-width: 100%; height: auto; margin-bottom: 10px;" border="0">`;
                    if (link) img = `<a href="${esc(appendUtm(link))}" target="_blank">${img}</a>`;
                    cellContent += img;
                }
                if (heading) {
                    cellContent += `<h3 style="margin: 0 0 6px 0; font-family: ${fontFamily}; font-size: ${d.headingSize}px; font-weight: 700; color: ${d.headingColor}; line-height: 1.3;">${escHtml(heading)}</h3>`;
                }
                if (text) {
                    text.split('\n').filter(p => p.trim()).forEach(p => {
                        cellContent += `<p style="margin: 0 0 8px 0; font-family: ${fontFamily}; font-size: ${d.textSize}px; color: ${d.textColor}; line-height: 1.5;">${escHtml(p)}</p>`;
                    });
                }
                if (!cellContent) cellContent = `<p style="color:#ccc; font-size:12px;">Spalte ${i}</p>`;
                const paddingRight = i < count ? `padding-right: ${gapPx}px;` : '';
                colsHtml += `
                    <td class="responsive-cell" width="${colWidth}" valign="top" style="width: ${colWidth}px; ${paddingRight} font-family: ${fontFamily};">
                        ${cellContent}
                    </td>`;
            }
            return `
                    <tr>
                        <td style="padding: ${d.paddingTop}px 20px ${d.paddingBottom}px 20px;">
                            <table role="presentation" class="responsive-table" cellpadding="0" cellspacing="0" border="0" width="100%">
                                <tr>
                                    ${colsHtml}
                                </tr>
                            </table>
                        </td>
                    </tr>`;
        }

        case 'social': {
            const iconPx = parseInt(d.iconSize) || 32;
            const gapPx = parseInt(d.gap) || 10;
            const bgStyle = d.bgColor ? `background-color: ${d.bgColor};` : '';
            const platforms = [
                { key: 'facebook', label: 'Fb', color: '#1877F2' },
                { key: 'instagram', label: 'Ig', color: '#E4405F' },
                { key: 'linkedin', label: 'Li', color: '#0A66C2' },
                { key: 'twitter', label: 'ùïè', color: '#000000' },
                { key: 'youtube', label: 'Yt', color: '#FF0000' },
                { key: 'tiktok', label: 'Tk', color: '#000000' },
                { key: 'website', label: 'üåê', color: '#555555' }
            ];
            let icons = '';
            platforms.forEach(p => {
                if (d[p.key]) {
                    icons += `
                    <td style="padding: 0 ${gapPx/2}px;">
                        <a href="${esc(appendUtm(d[p.key]))}" target="_blank" style="text-decoration: none;">
                            <table role="presentation" cellpadding="0" cellspacing="0" border="0">
                                <tr>
                                    <td style="background-color: ${p.color}; border-radius: ${Math.round(iconPx/2)}px; width: ${iconPx}px; height: ${iconPx}px; text-align: center; vertical-align: middle; font-size: ${Math.round(iconPx*0.4)}px; color: #ffffff; font-family: ${fontFamily}; font-weight: bold;">
                                        ${p.label}
                                    </td>
                                </tr>
                            </table>
                        </a>
                    </td>`;
                }
            });
            if (!icons) icons = '<td style="color:#aaa; font-size:12px;">Keine Social-Links eingetragen</td>';
            return `
                    <tr>
                        <td align="${d.align}" style="padding: ${d.paddingTop}px 20px ${d.paddingBottom}px 20px; ${bgStyle}">
                            <table role="presentation" cellpadding="0" cellspacing="0" border="0">
                                <tr>
                                    ${icons}
                                </tr>
                            </table>
                        </td>
                    </tr>`;
        }

        default:
            return '';
    }
}

// Escape but allow basic HTML in text fields (for links)
function escHtml(str) {
    if (!str) return '';
    // Allow <a> tags, escape everything else
    return str.replace(/</g, '&lt;').replace(/&lt;a /gi, '<a ').replace(/&lt;\/a&gt;/gi, '</a>').replace(/&lt;br\s*\/?&gt;/gi, '<br>');
}

// ===========================
// UPDATE PREVIEW
// ===========================
let previewTimeout = null;
function updatePreview() {
    clearTimeout(previewTimeout);
    previewTimeout = setTimeout(() => {
        const html = generateEmailHtml();
        const frame = document.getElementById('previewFrame');
        frame.srcdoc = html;

        // Update size info
        const size = new Blob([html]).size;
        const sizeKb = (size / 1024).toFixed(1);
        const info = document.getElementById('templateSizeInfo');
        if (size > 102000) {
            info.className = 'template-size-info warn';
            info.textContent = `‚ö†Ô∏è ${sizeKb} KB ‚Äì Gmail schneidet bei ~102 KB ab!`;
        } else {
            info.className = 'template-size-info';
            info.textContent = `üìè ${sizeKb} KB`;
        }

        // Update preview frame width
        const width = document.getElementById('settingWidth').value || 600;
        if (previewMode === 'desktop') {
            frame.style.width = width + 'px';
            document.getElementById('previewSizeLabel').textContent = width + 'px';
        }

        // Auto-resize iframe height
        frame.onload = () => {
            try {
                const h = frame.contentDocument.documentElement.scrollHeight;
                frame.style.height = Math.max(h, 400) + 'px';
            } catch(e) {}
        };

        // Update stats bar
        updateStats();
    }, 150);
}

// ===========================
// EXPORT HTML
// ===========================
function exportHtml() {
    const html = generateEmailHtml();
    const blob = new Blob([html], { type: 'text/html; charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    const title = document.getElementById('settingTitle').value || 'template';
    const safeName = title.replace(/[^a-zA-Z0-9√§√∂√º√Ñ√ñ√ú√ü_-]/g, '_').substring(0, 50);
    a.href = url;
    a.download = safeName + '.html';
    a.click();
    URL.revokeObjectURL(url);
}

// ===========================
// SAVE / LOAD TEMPLATE (localStorage)
// ===========================
function saveTemplate() {
    const name = prompt('Name f√ºr diese Vorlage:', document.getElementById('settingTitle').value || 'Meine Vorlage');
    if (!name) return;

    const templateData = getTemplateData();
    templateData.name = name;

    const saved = JSON.parse(localStorage.getItem('pw_templates') || '[]');
    // Check if name exists
    const existingIdx = saved.findIndex(t => t.name === name);
    if (existingIdx >= 0) {
        if (!confirm(`Vorlage "${name}" existiert bereits. √úberschreiben?`)) return;
        saved[existingIdx] = templateData;
    } else {
        saved.push(templateData);
    }
    localStorage.setItem('pw_templates', JSON.stringify(saved));
    alert(`‚úÖ Vorlage "${name}" gespeichert!`);
}

function loadTemplate() {
    const saved = JSON.parse(localStorage.getItem('pw_templates') || '[]');
    if (saved.length === 0) {
        alert('Keine gespeicherten Vorlagen vorhanden.');
        return;
    }

    const names = saved.map((t, i) => `${i + 1}. ${t.name}`).join('\n');
    const choice = prompt('Welche Vorlage laden?\n\n' + names + '\n\nNummer eingeben:');
    if (!choice) return;
    const idx = parseInt(choice) - 1;
    if (isNaN(idx) || idx < 0 || idx >= saved.length) {
        alert('Ung√ºltige Auswahl.');
        return;
    }

    applyTemplateData(saved[idx]);
    alert(`‚úÖ Vorlage "${saved[idx].name}" geladen!`);
}

// ===========================
// EXPORT / IMPORT TEMPLATE FILE
// ===========================
function exportTemplateFile() {
    const templateData = getTemplateData();
    const name = document.getElementById('settingTitle').value || 'vorlage';
    templateData.name = name;
    const json = JSON.stringify(templateData, null, 2);
    const blob = new Blob([json], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    const safeName = name.replace(/[^a-zA-Z0-9√§√∂√º√Ñ√ñ√ú√ü_-]/g, '_').substring(0, 50);
    a.href = url;
    a.download = safeName + '.json';
    a.click();
    URL.revokeObjectURL(url);
}

function importTemplateFile() {
    document.getElementById('importFileInput').click();
}

function handleImportFile(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = JSON.parse(e.target.result);
            applyTemplateData(data);
            alert(`‚úÖ Vorlage "${data.name || 'Unbenannt'}" importiert!`);
        } catch(err) {
            alert('‚ùå Fehler beim Importieren: Datei ist kein g√ºltiges Vorlagen-Format.');
        }
    };
    reader.readAsText(file);
    event.target.value = '';
}

// ===========================
// UTM TRACKING HELPER
// ===========================
function appendUtm(url) {
    if (!url || url.startsWith('#') || url.startsWith('data:')) return url;
    const tracking = document.getElementById('settingTracking').value;
    if (tracking !== 'utm') return url;
    const source = document.getElementById('settingUtmSource').value;
    const medium = document.getElementById('settingUtmMedium').value;
    const campaign = document.getElementById('settingUtmCampaign').value;
    if (!source && !medium && !campaign) return url;
    const sep = url.includes('?') ? '&' : '?';
    let params = [];
    if (source) params.push('utm_source=' + encodeURIComponent(source));
    if (medium) params.push('utm_medium=' + encodeURIComponent(medium));
    if (campaign) params.push('utm_campaign=' + encodeURIComponent(campaign));
    return url + sep + params.join('&');
}

function toggleTrackingFields() {
    const val = document.getElementById('settingTracking').value;
    document.getElementById('trackingFields').style.display = val === 'utm' ? 'block' : 'none';
    updatePreview();
}

// ===========================
// STATS UPDATE
// ===========================
function updateStats() {
    // Block count
    document.getElementById('statBlocks').textContent = 'üì¶ ' + blocks.length + ' Bl√∂cke';

    // Count images and text
    let imgCount = 0;
    let textLength = 0;
    let linkCount = 0;

    blocks.forEach(b => {
        const d = b.data;
        switch(b.type) {
            case 'header-image':
            case 'image':
                imgCount++;
                if (d.link) linkCount++;
                break;
            case 'image-text':
                imgCount++;
                textLength += (d.heading || '').length + (d.text || '').length;
                if (d.imageLink) linkCount++;
                break;
            case 'text':
                textLength += (d.heading || '').length + (d.text || '').length;
                break;
            case 'button':
                linkCount++;
                break;
            case 'columns': {
                const cnt = parseInt(d.count) || 2;
                for (let i = 1; i <= cnt; i++) {
                    if (d['col'+i+'ImageSrc']) imgCount++;
                    textLength += (d['col'+i+'Heading'] || '').length + (d['col'+i+'Text'] || '').length;
                    if (d['col'+i+'Link']) linkCount++;
                }
                break;
            }
            case 'social':
                ['facebook','instagram','linkedin','twitter','youtube','tiktok','website'].forEach(k => {
                    if (d[k]) linkCount++;
                });
                break;
            case 'footer':
                linkCount += 2;
                textLength += (d.text || '').length;
                break;
        }
    });

    // Ratio
    const ratioEl = document.getElementById('statRatio');
    if (imgCount === 0 && textLength === 0) {
        ratioEl.textContent = 'üìä Text/Bild: ‚Äì';
        ratioEl.className = 'stat-chip';
    } else if (imgCount === 0) {
        ratioEl.textContent = 'üìä Nur Text (kein Bild)';
        ratioEl.className = 'stat-chip';
    } else {
        const ratio = textLength > 0 ? (textLength / (imgCount * 100)).toFixed(1) : 0;
        if (ratio < 0.5) {
            ratioEl.textContent = 'üìä Wenig Text, viele Bilder';
            ratioEl.className = 'stat-chip warn';
        } else {
            ratioEl.textContent = 'üìä Text/Bild-Verh√§ltnis OK';
            ratioEl.className = 'stat-chip good';
        }
    }

    // Links
    document.getElementById('statLinks').textContent = 'üîó ' + linkCount + ' Links';
}

// ===========================
// TEMPLATE DATA HELPERS
// ===========================
function getTemplateData() {
    return {
        version: 2,
        settings: {
            title: document.getElementById('settingTitle').value,
            width: document.getElementById('settingWidth').value,
            bgColor: document.getElementById('settingBgColorText').value,
            contentBg: document.getElementById('settingContentBgText').value,
            font: document.getElementById('settingFont').value,
            customFont: document.getElementById('settingCustomFont').value,
            customFontUrl: document.getElementById('settingCustomFontUrl').value,
            type: document.getElementById('settingType').value,
            pixel: document.getElementById('settingPixel').value,
            tracking: document.getElementById('settingTracking').value,
            utmSource: document.getElementById('settingUtmSource').value,
            utmMedium: document.getElementById('settingUtmMedium').value,
            utmCampaign: document.getElementById('settingUtmCampaign').value
        },
        blocks: blocks.map(b => ({ type: b.type, data: JSON.parse(JSON.stringify(b.data)) }))
    };
}

function applyTemplateData(data) {
    if (data.settings) {
        const s = data.settings;
        document.getElementById('settingTitle').value = s.title || '';
        document.getElementById('settingWidth').value = s.width || 600;
        document.getElementById('settingBgColorText').value = s.bgColor || '#f4f4f4';
        document.getElementById('settingBgColor').value = s.bgColor || '#f4f4f4';
        document.getElementById('settingContentBgText').value = s.contentBg || '#ffffff';
        document.getElementById('settingContentBg').value = s.contentBg || '#ffffff';
        document.getElementById('settingFont').value = s.font || 'Arial, Helvetica, sans-serif';
        document.getElementById('settingCustomFont').value = s.customFont || '';
        document.getElementById('settingCustomFontUrl').value = s.customFontUrl || '';
        document.getElementById('settingType').value = s.type || 'standard';
        document.getElementById('settingPixel').value = s.pixel || 'placeholder';
        document.getElementById('settingTracking').value = s.tracking || 'none';
        document.getElementById('settingUtmSource').value = s.utmSource || '';
        document.getElementById('settingUtmMedium').value = s.utmMedium || '';
        document.getElementById('settingUtmCampaign').value = s.utmCampaign || '';
        toggleTrackingFields();
    }
    if (data.blocks) {
        blocks = [];
        blockIdCounter = 0;
        data.blocks.forEach(b => {
            blocks.push({
                id: ++blockIdCounter,
                type: b.type,
                data: JSON.parse(JSON.stringify(b.data)),
                collapsed: false
            });
        });
    }
    renderBlocks();
    updatePreview();
}

// ===========================
// INIT
// ===========================
updatePreview();

</script>
</body>
</html>
